---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";

export async function getStaticPaths() {
	const posts = await getCollection("blog");

	// Extract all categories
	const categoryMap = new Map<string, any[]>();

	posts.forEach((post) => {
		if (post.data.categories) {
			post.data.categories.forEach((category) => {
				if (!categoryMap.has(category)) {
					categoryMap.set(category, []);
				}
				categoryMap.get(category)?.push(post);
			});
		}
	});

	// Generate paths for each category
	return Array.from(categoryMap.entries()).map(([categoryName, categoryPosts]) => {
		const categorySlug = categoryName
			.toLowerCase()
			.normalize("NFD")
			.replace(/[\u0300-\u036f]/g, "") // Remove diacritics
			.replace(/[^a-z0-9\s-]/g, "") // Remove special characters
			.trim()
			.replace(/\s+/g, "-"); // Replace spaces with hyphens

		return {
			params: { slug: categorySlug },
			props: {
				categoryName,
				posts: categoryPosts.sort(
					(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
				),
			},
		};
	});
}

const { categoryName, posts } = Astro.props;

// SEO optimizations
const seoTitle = `${categoryName} - Jessica Things | Posts sobre ${categoryName}`;
const seoDescription = `Descubra ${posts.length} ${posts.length === 1 ? "post" : "posts"} sobre ${categoryName} no Jessica Things. Conteúdo especializado em beleza, moda e estilo de vida.`;

// Structured data for category page
const structuredData = {
	"@context": "https://schema.org",
	"@type": "CollectionPage",
	name: `${categoryName} - Jessica Things`,
	description: seoDescription,
	url: new URL(
		`/category/${categoryName
			.toLowerCase()
			.normalize("NFD")
			.replace(/[\u0300-\u036f]/g, "")
			.replace(/[^a-z0-9\s-]/g, "")
			.trim()
			.replace(/\s+/g, "-")}`,
		Astro.site,
	).toString(),
	isPartOf: {
		"@type": "WebSite",
		name: "Jessica Things",
		url: Astro.site?.toString(),
	},
	mainEntity: {
		"@type": "ItemList",
		numberOfItems: posts.length,
		itemListElement: posts.slice(0, 20).map((post, index) => ({
			"@type": "BlogPosting",
			position: index + 1,
			headline: post.data.title,
			description: post.data.description,
			url: new URL(post.slug, Astro.site).toString(),
			datePublished: new Date(post.data.date).toISOString(),
			author: {
				"@type": "Person",
				name: "Jessica",
			},
		})),
	},
	breadcrumb: {
		"@type": "BreadcrumbList",
		itemListElement: [
			{
				"@type": "ListItem",
				position: 1,
				name: "Início",
				item: Astro.site?.toString(),
			},
			{
				"@type": "ListItem",
				position: 2,
				name: "Categorias",
				item: new URL("/categories", Astro.site).toString(),
			},
			{
				"@type": "ListItem",
				position: 3,
				name: categoryName,
			},
		],
	},
};
---

<BaseLayout title={seoTitle} description={seoDescription} structuredData={structuredData}>
	<div class="min-h-screen bg-white">
		<Header currentPage="categories" />

		<main class="container mx-auto px-4 py-6 md:py-8">
			<!-- Breadcrumb -->
			<nav class="mb-8" aria-label="Breadcrumb">
				<ol class="flex items-center space-x-2 text-sm text-gray-500">
					<li>
						<a href="/" class="hover:text-gray-700">Início</a>
					</li>
					<li>
						<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
							<path
								fill-rule="evenodd"
								d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
								clip-rule="evenodd"></path>
						</svg>
					</li>
					<li>
						<a href="/categories" class="hover:text-gray-700">Categorias</a>
					</li>
					<li>
						<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
							<path
								fill-rule="evenodd"
								d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
								clip-rule="evenodd"></path>
						</svg>
					</li>
					<li class="font-medium text-gray-900" aria-current="page">
						{categoryName}
					</li>
				</ol>
			</nav>

			<!-- Category Header -->
			<div class="mb-12 text-center">
				<div
					class="mb-4 inline-flex h-16 w-16 items-center justify-center rounded-lg bg-gradient-to-br from-pink-500 to-purple-600"
				>
					<span class="text-2xl font-bold text-white">
						{categoryName.charAt(0).toUpperCase()}
					</span>
				</div>
				<h1 class="mb-4 text-4xl font-bold text-gray-900">{categoryName}</h1>
				<p class="mx-auto max-w-2xl text-xl text-gray-600">
					{posts.length}
					{posts.length === 1 ? "post" : "posts"} nesta categoria
				</p>
			</div>

			<!-- Posts Grid -->
			<div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3">
				{
					posts.map((post) => (
						<article class="group overflow-hidden rounded-lg border border-gray-200 bg-white transition-all duration-300 hover:shadow-lg">
							<div class="relative overflow-hidden">
								<img
									src={post.data.thumbnail || "/placeholder-image.svg"}
									alt={post.data.title}
									class="h-48 w-full object-cover transition-transform duration-300 group-hover:scale-105"
									loading="lazy"
								/>
								<div class="absolute left-3 top-3">
									<span class="rounded bg-black px-2 py-1 text-xs font-medium text-white">
										{categoryName}
									</span>
								</div>
							</div>

							<div class="p-6">
								<div class="mb-2 text-sm text-gray-500">
									{new Date(post.data.date).toLocaleDateString("pt-BR", {
										month: "long",
										day: "numeric",
										year: "numeric",
									})}
								</div>

								<h3 class="mb-3 line-clamp-2 text-xl font-bold text-gray-900 transition-colors group-hover:text-purple-600">
									<a href={`/${post.slug}`} class="hover:underline">
										{post.data.title}
									</a>
								</h3>

								{(post.data.excerpt || post.data.description) && (
									<p class="mb-4 line-clamp-3 text-sm text-gray-600">
										{post.data.excerpt || post.data.description}
									</p>
								)}

								{post.data.tags && post.data.tags.length > 0 && (
									<div class="mb-4">
										<div class="flex flex-wrap gap-1">
											{post.data.tags.slice(0, 3).map((tag: string) => (
												<span class="rounded bg-gray-100 px-2 py-1 text-xs text-gray-600">
													{tag}
												</span>
											))}
											{post.data.tags.length > 3 && (
												<span class="text-xs text-gray-500">+{post.data.tags.length - 3} mais</span>
											)}
										</div>
									</div>
								)}

								<a
									href={`/${post.slug}`}
									class="inline-flex items-center text-sm font-medium text-purple-600 hover:text-purple-700 group-hover:underline"
								>
									Ler Mais
									<svg
										class="ml-1 h-4 w-4 transform transition-transform group-hover:translate-x-1"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M17 8l4 4m0 0l-4 4m4-4H3"
										/>
									</svg>
								</a>
							</div>
						</article>
					))
				}
			</div>

			<!-- Back to Categories -->
			<div class="mt-16 text-center">
				<a
					href="/categories"
					class="inline-flex items-center rounded-lg bg-purple-600 px-6 py-3 font-medium text-white transition-colors hover:bg-purple-700"
				>
					<svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
					</svg>
					Navegar Todas as Categorias
				</a>
			</div>
		</main>

		<!-- Footer -->
		<footer class="mt-16 border-t border-gray-200 bg-gray-50">
			<div class="container mx-auto px-4 py-12">
				<div class="grid grid-cols-1 gap-8 md:grid-cols-4">
					<div>
						<h3 class="mb-4 text-lg font-bold text-gray-900">Jessica Things</h3>
						<p class="text-sm text-gray-600">
							Sua fonte de inspiração para beleza, moda e estilo de vida.
						</p>
					</div>
					<div>
						<h4 class="mb-4 text-sm font-semibold text-gray-900">Links Rápidos</h4>
						<ul class="space-y-2 text-sm text-gray-600">
							<li><a href="/" class="hover:text-gray-900">Início</a></li>
							<li><a href="/categories" class="hover:text-gray-900">Categorias</a></li>
							<li><a href="/about" class="hover:text-gray-900">Sobre</a></li>
							<li><a href="/contact" class="hover:text-gray-900">Contato</a></li>
						</ul>
					</div>
					<div>
						<h4 class="mb-4 text-sm font-semibold text-gray-900">Siga-nos</h4>
						<ul class="space-y-2 text-sm text-gray-600">
							<li>
								<a href="https://www.instagram.com/jessicatthings_" class="hover:text-gray-900"
									>Instagram</a
								>
							</li>
							<li>
								<a href="https://www.youtube.com/@JessicaThings_" class="hover:text-gray-900"
									>YouTube</a
								>
							</li>
							<li>
								<a href="https://www.tiktok.com/@jessicatthings_" class="hover:text-gray-900"
									>TikTok</a
								>
							</li>
						</ul>
					</div>
					<div>
						<h4 class="mb-4 text-sm font-semibold text-gray-900">Newsletter</h4>
						<p class="mb-4 text-sm text-gray-600">Receba as últimas atualizações</p>
						<form class="flex">
							<input
								type="email"
								placeholder="Seu e-mail"
								class="flex-1 rounded-l border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
							/>
							<button
								type="submit"
								class="rounded-r bg-purple-600 px-4 py-2 text-white transition-colors hover:bg-purple-700"
							>
								Inscrever
							</button>
						</form>
					</div>
				</div>
				<div class="mt-8 border-t border-gray-200 pt-8 text-center text-sm text-gray-600">
					<p>&copy; 2025 Jessica Things. Todos os direitos reservados.</p>
				</div>
			</div>
		</footer>
	</div>
</BaseLayout>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
